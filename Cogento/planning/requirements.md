# Cogento - Requirements & Features

## Overview

This document captures the requirements and features for Cogento, a self-hosted membership management system using Stripe as source of truth.

**Last Updated:** 2025-01-10

## Core Requirements

### Functional Requirements

**Data Management:**
- ✅ Stripe is the **single source of truth** for all membership data
- ✅ All **writes, updates, and deletes** are made to Stripe (Customers and Subscriptions)
- ✅ Customer records in Stripe store core member information (name, email, phone, address)
- ✅ Subscription records in Stripe store membership package information (plan, status, dates)
- ✅ Stripe **metadata fields** are used to store custom attributes required by the membership system
- ✅ Separate PostgreSQL database for reporting and analytics (one-way sync from Stripe)
- ✅ Reporting database can be regenerated from scratch from Stripe at any time
- ✅ Stripe webhooks support near real-time sync to reporting database
- ✅ **No password storage** - Authentication tokens generated on-demand, not stored

**Payment Processing:**
- ✅ Stripe handles all payment processing (renewals, invoices, payment failures)
- ✅ Stripe is the authoritative source for payment and subscription status

**User Interface:**
- ✅ Web interface for users to interact with Cogento
- ✅ Mobile interface for users to interact with Cogento

**User Roles:**
- ✅ **Superuser** - Highest level of access/control
  - Access to all functions in Cogento
  - CRUD access to all data in the system
- ✅ **Admin** - Administrative access to manage the system
  - CRUD access to all users in the system
- ✅ **Normal Users (Members)** - Club members with standard access
  - Read access only to their own data
  - Write access to their own metadata
- ✅ Superuser and Admin users can also be members (role assignment is independent of membership status)

**User Registration:**
- ✅ Registration is **implicit** - occurs when a user subscribes in Stripe
- ✅ New Stripe subscription automatically creates:
  - Stripe Customer record (if new customer)
  - Stripe Subscription record
- ✅ User is recognized as a member once Customer + Subscription records exist in Stripe
- ✅ No separate registration step required - subscription equals membership

**User Authentication:**
- ✅ Passwordless authentication system
- ✅ Users sign in using:
  - Email address (as recorded in Stripe Customer record)
  - Authentication token (generated by UI and sent to email address)
- ✅ No password storage required - tokens generated on-demand
- ✅ Token-based email authentication flow

**Future Considerations:**
- ⏸️ Support for other payment systems (beyond Stripe) may be added in the future
- ⏸️ This is **not** an immediate requirement for initial implementation

### Non-Functional Requirements

*[To be documented]*

## Features

### Planned Features

**Testing & Demo Tools:**
- ✅ **Bulk Load Tool API** - API endpoint for CSV import to populate Stripe with customers and subscriptions
  - Purpose: Testing and demo purposes
  - Input: CSV file with member data
  - Output: Creates Stripe Customer records and Subscription records
  - Allows rapid setup of test/demo data in Stripe
  - Hosted in Python FastAPI service
- ✅ **Bulk Metadata Update Tool API** - API endpoint for bulk updating Stripe metadata
  - Purpose: Update existing Stripe Customer and/or Subscription records with metadata
  - Input: CSV file with emails and associated Customer and/or Subscription metadata
  - Output: Updates metadata fields on existing Stripe Customer and/or Subscription records
  - Allows bulk import of custom attributes to existing Stripe records
  - Hosted in Python FastAPI service

*[Additional features to be documented]*

### Future Features

*[To be documented]*

## User Stories

### Superuser

**Permissions:**
- ✅ Access to all functions in Cogento
- ✅ CRUD (Create, Read, Update, Delete) access to all data in the system
- ✅ Full administrative control

**Use Cases:**
- *[To be documented - specific use cases]*

### Admin

**Permissions:**
- ✅ CRUD (Create, Read, Update, Delete) access to all users in the system
- ✅ User management functions

**Use Cases:**
- *[To be documented - specific use cases]*

### Normal Users (Members)

**Registration Flow:**
- User selects subscription plan in Stripe (via Stripe Checkout or similar)
- Stripe creates Customer record (if new) and Subscription record
- User is automatically recognized as a member (registration is implicit)
- No separate registration step required

**Authentication Flow:**
- User requests sign-in with email address
- System generates authentication token and sends to email
- User enters token to complete sign-in
- User can now access member portal

**Member Features:**
- *[To be documented - specific member portal features]*

**Note:** Superuser and Admin users can also be members, allowing them to have both administrative privileges and regular member access.

## Technical Requirements

### Architecture Requirements

**Data Architecture:**
- ✅ **Stripe as single source of truth** - All membership data stored in Stripe (Customers and Subscriptions)
- ✅ **All writes to Stripe** - Create, update, delete operations go directly to Stripe
- ✅ **Stripe metadata for custom attributes** - Extended member data stored in Stripe Customer/Subscription metadata fields
- ✅ **Separate PostgreSQL database** - Dedicated reporting and analytics database (separate from application)
- ✅ **One-way sync** - Stripe → PostgreSQL (no bidirectional sync, Stripe is always authoritative)
- ✅ **Webhook-based near real-time sync** - Stripe webhooks maintain PostgreSQL in near real-time
- ✅ **Full regeneration capability** - Can regenerate PostgreSQL reporting database from scratch from Stripe at any time
- ✅ **Backup/recovery handled by Stripe** - Stripe Company handles backup, recovery, and resilience for membership data
- ✅ **No backup needed for reporting DB** - PostgreSQL can be regenerated from Stripe at any time, so no backup/restore required

**API Service:**
- ✅ **Python FastAPI service** - Backend API service built with Python and FastAPI
- ✅ **Stripe API interaction** - Handles all Stripe API calls (reads, writes, updates)
- ✅ **Bulk loading APIs** - Hosts APIs for bulk load features (CSV import tools)
- ✅ **Webhook handling** - Receives and processes Stripe webhooks
- ✅ **Application API** - Provides APIs for web/mobile UI interfaces

**Deployment & Packaging:**
- ✅ **Docker Compose** - Single docker-compose project for packaging and deployment
- ✅ **Docker Compose services:**
  - UI component (Vite/TypeScript frontend)
  - API component (Python FastAPI backend)
  - PostgreSQL component (reporting/analytics database)
- ✅ Self-hosted deployment (all components deployed together via docker-compose)
- ✅ Single project name describes all components (UI, API, PostgreSQL)
- ✅ Webhook-based real-time sync from Stripe to PostgreSQL

**Payment Gateway:**
- ✅ Stripe as primary (and initial) payment gateway
- ✅ API routes use `/stripe/{resource}` pattern (e.g., `/stripe/customers`)
- ⏸️ Future: Architecture may support multiple payment systems (not required for v1)
- ✅ API naming conventions designed to support future payment gateway additions

### Integration Requirements

**API Service:**
- ✅ Python FastAPI backend service
- ✅ Stripe API integration (for reads and writes to Stripe)
- ✅ Webhook endpoint for Stripe events (near real-time sync to PostgreSQL)
- ✅ Bulk loading API endpoints (for CSV import tools)
- ✅ Email service integration (for sending authentication tokens)
- ✅ Stripe Customer/Subscription API (for verifying user identity and membership status)

**API Naming Conventions:**
- ✅ **Payment gateway prefix pattern** - All payment gateway interactions use pattern: `/stripe/{resource}`
  - Example: `/stripe/customers`, `/stripe/subscriptions`, `/stripe/webhooks`
- ✅ **Future-proof design** - Pattern allows for additional payment gateways:
  - Future: `/paypal/customers`, `/square/customers`, etc.
- ✅ **Consistent routing** - All Stripe-related endpoints follow this pattern
- ✅ **Gateway abstraction** - API structure supports multiple payment gateways in future
- ✅ **Reporting database prefix pattern** - All reporting database interactions use pattern: `/postgres/{resource}`
  - Example: `/postgres/members`, `/postgres/subscriptions`, `/postgres/reports`
- ✅ **Future-proof design** - Pattern allows for additional reporting databases:
  - Future: `/mysql/{resource}`, `/mongo/{resource}`, etc.
- ✅ **Consistent routing** - All PostgreSQL/reporting database endpoints follow this pattern
- ✅ **Database abstraction** - API structure supports multiple reporting databases in future

**Data & Infrastructure:**
- ✅ Separate PostgreSQL database for reporting/analytics
- ✅ Full regeneration script (reads all Stripe data and populates PostgreSQL from scratch)
- ✅ API routes use `/postgres/{resource}` pattern (e.g., `/postgres/members`, `/postgres/reports`)
- ✅ API naming conventions designed to support future reporting database additions

**Deployment & Packaging:**
- ✅ Docker Compose for packaging and deployment
- ✅ Single docker-compose project includes: UI, API, and PostgreSQL services
- ✅ All components deployed together in a single docker-compose stack

### Development & Testing Tools

**Bulk Data Import Tools:**

**Note:** These tools are implemented as API endpoints in the Python FastAPI service.

1. **Bulk Load Tool API** (Customer & Subscription Creation):
   - ✅ API endpoint for CSV import to create Stripe Customer records
   - ✅ Creates Stripe Subscription records based on CSV data
   - ✅ Supports importing metadata fields from CSV to Stripe Customer/Subscription metadata
   - ✅ Hosted in FastAPI service
   - ✅ Useful for:
     - Setting up test environments
     - Creating demo data
     - Migrating initial member data from spreadsheets/existing systems

2. **Bulk Metadata Update Tool API** (Metadata Updates Only):
   - ✅ API endpoint for bulk updating Stripe metadata
   - ✅ Input: CSV file with email addresses and associated Customer and/or Subscription metadata
   - ✅ Updates existing Stripe Customer records with metadata (matched by email)
   - ✅ Updates existing Stripe Subscription records with metadata (matched by Customer email)
   - ✅ Supports updating Customer metadata and/or Subscription metadata separately or together
   - ✅ Hosted in FastAPI service
   - ✅ Useful for:
     - Adding custom attributes to existing members
     - Bulk updates of member metadata
     - Migrating metadata from external systems to existing Stripe records
     - Testing metadata functionality with existing data

### User Interface Requirements

**Technology Stack:**
- ✅ **Vite** - Build tool and development server for the UI
- ✅ **TypeScript** - Programming language for type-safe frontend code
- ✅ **Material Design (Material.io)** - UI component framework for look and feel
- ✅ **Tailwind CSS** - Utility-first CSS framework for styling and CSS management
- ✅ Modern web standards and responsive design

**Interface Types:**
- ✅ Web interface (responsive web application)
- ✅ Mobile interface (native mobile app or responsive mobile web)

**User Roles:**
- ✅ Three user role types: Superuser, Admin, Normal Users (Members)
- ✅ Role assignment independent of membership status (superuser/admin can also be members)
- ✅ Role-based access control (RBAC) for different interface features and permissions

**Role Permissions:**
- ✅ **Superuser:** All functions + CRUD access to all data
- ✅ **Admin:** CRUD access to all users
- ✅ **Normal Users:** Read access to own data + Write access to own metadata

**Interface Features:**
- *[To be documented - specific features per role]*

### Performance Requirements

*[To be documented]*

### Security Requirements

**Authentication & Authorization:**
- ✅ **Passwordless authentication** - No password storage required
- ✅ **Implicit registration** - Membership created when Stripe subscription is created
- ✅ **Email-based authentication** - Users sign in with email (from Stripe Customer record)
- ✅ **Token-based sign-in** - Authentication tokens generated on-demand and sent via email
- ✅ **Stripe Customer as identity source** - User identity verified against Stripe Customer records
- ✅ Role-based access control (RBAC) with three roles: Superuser, Admin, Normal Users
- ✅ Users can have multiple roles (e.g., Admin + Member)
- ✅ Role assignment independent of Stripe Customer status
- ✅ Only users with active Stripe Customer + Subscription records can authenticate

**Role-Based Permissions:**
- ✅ **Superuser:**
  - Access to all functions in Cogento
  - CRUD (Create, Read, Update, Delete) access to all data in the system
- ✅ **Admin:**
  - CRUD (Create, Read, Update, Delete) access to all users in the system
- ✅ **Normal Users (Members):**
  - Read access only to their own data
  - Write access to their own metadata

*[Additional security requirements to be documented]*

**Authentication Flow:**
1. User requests sign-in (provides email address)
2. System verifies email exists in Stripe Customer records
3. System generates authentication token
4. Token sent to user's email address (from Stripe Customer record)
5. User enters token to complete sign-in
6. Token is single-use and time-limited (expires after use or timeout)

### Data Requirements

**Reporting Database:**
- ✅ Separate PostgreSQL database for reporting and analytics (not shared with application)
- ✅ One-way sync from Stripe (Stripe → PostgreSQL only, no writes back to Stripe)
- ✅ Must support full regeneration from Stripe at any time
- ✅ Must support near real-time sync via Stripe webhooks
- ✅ Target audience: Small clubs (typically 200-500 members) - PostgreSQL regeneration is feasible

**Data Sync Strategy:**
- ✅ **Primary sync method:** Stripe webhooks for near real-time updates
- ✅ **Recovery/initialization:** Full regeneration script that reads all Stripe data (Customers, Subscriptions, Invoices)
- ✅ **Idempotency:** Sync operations must be idempotent (safe to replay webhooks, regenerate)
- ✅ **Data integrity:** If PostgreSQL is corrupted or out of sync, always regenerate from Stripe (Stripe is authoritative)

**Backup & Recovery Strategy:**
- ✅ **Stripe handles membership data backup/recovery** - Stripe is trusted single source of truth
- ✅ **Stripe infrastructure responsibility** - Stripe Company handles backup, recovery, and resilience for all membership data
- ✅ **No membership data backup required** - Cogento relies on Stripe's infrastructure for data protection
- ✅ **Reporting database regeneration** - PostgreSQL reporting database can be regenerated from scratch at any time from Stripe
- ✅ **No backup/restore needed for reporting DB** - If reporting database is lost, simply regenerate from Stripe
- ✅ **Simplified architecture** - No complex backup strategies needed for membership data (Stripe handles it)
- ✅ **Recovery strategy** - Always regenerate reporting database from Stripe (source of truth) if needed

## Constraints

### Business Constraints

- Must be FREE (no monthly SaaS fees)
- Must be self-hosted
- Must use Stripe as payment gateway (and source of truth)

### Technical Constraints

*[To be documented]*

## Out of Scope

**Initial Release (v1.0):**
- ❌ Support for payment systems other than Stripe (future consideration)
- ❌ Multi-tenant or SaaS deployment (self-hosted single-tenant only)
- *[Additional out-of-scope items to be documented]*

## Notes

*[Additional notes, questions, or considerations]*
